import requests
import pymongo
import bs4

client = pymongo.MongoClient('mongodb://localhost:27017/')
db = client['THT']
col = db['0daytoday']

## first meeting part
headers = {
    'authority': '0day.today',
    'cache-control': 'max-age=0',
    'sec-ch-ua': '" Not A;Brand";v="99", "Chromium";v="98", "Google Chrome";v="98"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'upgrade-insecure-requests': '1',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36',
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
    'sec-fetch-site': 'cross-site',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-user': '?1',
    'sec-fetch-dest': 'document',
    'referer': 'https://www.google.com/',
    'accept-language': 'tr-TR,tr;q=0.9',
    'cookie': '_ga=GA1.2.460894186.1645271046; _gid=GA1.2.1073089277.1645271046',
}

response = requests.get('https://0day.today/local', headers=headers)


a = str(response.cookies)
b = a.split("PHPSESSID=")
c = b[1].split(" ")
phpsessid = c[0]


## agree part
headers = {
    'authority': '0day.today',
    'cache-control': 'max-age=0',
    'sec-ch-ua': '" Not A;Brand";v="99", "Chromium";v="98", "Google Chrome";v="98"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'upgrade-insecure-requests': '1',
    'origin': 'https://0day.today',
    'content-type': 'application/x-www-form-urlencoded',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36',
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
    'sec-fetch-site': 'same-origin',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-user': '?1',
    'sec-fetch-dest': 'document',
    'referer': 'https://0day.today/local',
    'accept-language': 'tr-TR,tr;q=0.9',
    'cookie': 'PHPSESSID='+phpsessid+'; _ga=GA1.2.460894186.1645271046; _gid=GA1.2.1073089277.1645271046; _gat_gtag_UA_23466659_1=1',
}

data = {
  'agree': 'Yes, I agree'
}

response = requests.post('https://0day.today/local', headers=headers, data=data)

## back part
headers = {
    'authority': '0day.today',
    'cache-control': 'max-age=0',
    'upgrade-insecure-requests': '1',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36',
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
    'sec-fetch-site': 'same-origin',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-user': '?1',
    'sec-fetch-dest': 'document',
    'sec-ch-ua': '" Not A;Brand";v="99", "Chromium";v="98", "Google Chrome";v="98"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'referer': 'https://0day.today/local',
    'accept-language': 'tr-TR,tr;q=0.9',
    'cookie': 'PHPSESSID='+phpsessid+'; _ga=GA1.2.460894186.1645271046; _gid=GA1.2.1073089277.1645271046; _gat_gtag_UA_23466659_1=1',
}
response = requests.get('https://0day.today/back', headers=headers)

## list part
headers = {
    'authority': '0day.today',
    'cache-control': 'max-age=0',
    'upgrade-insecure-requests': '1',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36',
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
    'sec-fetch-site': 'same-origin',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-user': '?1',
    'sec-fetch-dest': 'document',
    'sec-ch-ua': '" Not A;Brand";v="99", "Chromium";v="98", "Google Chrome";v="98"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'referer': 'https://0day.today/local',
    'accept-language': 'tr-TR,tr;q=0.9',
    'cookie': 'PHPSESSID='+phpsessid+'; _ga=GA1.2.460894186.1645271046; _gid=GA1.2.1073089277.1645271046; _gat_gtag_UA_23466659_1=1',
}

response = requests.get('https://0day.today/local', headers=headers)

html = response.text
parser = bs4.BeautifulSoup(html, 'html.parser')
exploits = parser.find_all('div', {'class': "ExploitTableContent"})

for exploit in exploits:
    sections = exploit.find_all('div',{'class':'td'})
    exploit_id = sections[1].find('a')['href'].replace("/exploit/description/","")
    
    if len(list(col.find({'exploit_id': exploit_id}))) == 0:
        datetime = sections[0].text
        title = exploit.find('div', {'class': 'allow_tip'}).find('a').text
        exploit_type = sections[2].text
        exploit_hits = sections[3].text
        author = sections[10].text
        exploit_link= "https://tr.0day.today/exploit/description/"+exploit_id
        
        data = {
            'exploit_link': exploit_link,
            'exploit_id': exploit_id,
            'date': datetime,
            'title': title,
            'type': exploit_type,
            'hits': exploit_hits,
            'author': author
        }
        col.insert_one(data)
