from selenium.webdriver.firefox.options import Options
from selenium import webdriver
import pymongo
import time
import bs4


class ZeroDayToday:
    def __init__(self):
        self.client = pymongo.MongoClient('mongodb://localhost:27017/')
        self.db = self.client['THT']
        self.col = self.db['0daytoday']
        self.options = Options()
        self.options.headless = True
        self.browser = webdriver.Firefox(options=self.options)
    
    def Script(self):
        self.browser.get("https://tr.0day.today/")

        button = self.browser.find_element_by_xpath('/html/body/div/div[1]/div[12]/div[3]/form/input')
        button.click()

        time.sleep(10)
        button = self.browser.find_element_by_xpath('/html/body/div[3]/div/div/a')
        button.click()

        html = self.browser.page_source
        self.browser.quit()
        parser = bs4.BeautifulSoup(html, 'html.parser')
        exploits = parser.find_all('div', {'class': "ExploitTableContent"})

        for exploit in exploits:
            sections = exploit.find_all('div',{'class':'td'})
            exploit_id = sections[1].find('a')['href'].replace("/exploit/description/","")

            if len(list(self.col.find({'exploit_id': exploit_id}))) == 0:
                datetime = sections[0].text
                title = exploit.find('div', {'class': 'allow_tip'}).find('a').text
                exploit_type = sections[2].text
                exploit_hits = sections[3].text
                author = sections[10].text
                exploit_link= "https://tr.0day.today/exploit/description/"+exploit_id
                
                data = {
                    'exploit_link': exploit_link,
                    'exploit_id': exploit_id,
                    'date': datetime,
                    'title': title,
                    'type': exploit_type,
                    'hits': exploit_hits,
                    'author': author
                }
                self.col.insert_one(data)

if __name__ == '__main__':
    
    App = ZeroDayToday()
    print("0DayToday Exploit Bilgileri Çekiliyor.")
    App.Script()
    print("İşlem Tamamlandı.")